import{a as b}from"./index-D9w9XwWd.js";import{a as w,e as u,h as g,s as q,f as I}from"./funcoes-vPaU6AKm.js";$(".responder-pergunta").click(function(){let e=$(this).attr("pergunta");$("#btn_salvar_respostas").attr("pergunta",e);let r=$("#formulario_id").val();if(v==!1){h(!1),f(!1),m(!1),$("input[name='adequacao']").prop("checked",!1),$("input[name='probabilidade']").prop("checked",!1),$("input[name='impacto']").prop("checked",!1),$("input[name='esforco']").prop("checked",!1),$("input[name='valor']").prop("checked",!1),$("#resposta").val(""),w("modal_dados_formulario");return}b.get(`${app_url}/respostas/detalhes_resposta/${r}/${e}`).then(o=>{let a=o.data.pergunta,n=o.data.resposta;$("#titulo_pergunta").html(a.titulo),n==null?(h(!1),f(!1),m(!1),$("input[name='adequacao']").prop("checked",!1),$("input[name='probabilidade']").prop("checked",!1),$("input[name='impacto']").prop("checked",!1),$("input[name='esforco']").prop("checked",!1),$("input[name='valor']").prop("checked",!1),$("#resposta").val("")):($(`input[name='adequacao'][value='${n.nivel_adequacao}']`).prop("checked",!0),h(),$(`input[name='probabilidade'][value='${n.nivel_probabilidade}']`).prop("checked",!0),$(`input[name='impacto'][value='${n.nivel_impacto}']`).prop("checked",!0),m(),$(`input[name='esforco'][value='${n.nivel_esforco}']`).prop("checked",!0),$(`input[name='valor'][value='${n.nivel_valor}']`).prop("checked",!0),f(),$("#resposta").val(n.resposta)),w("modal_dados_formulario")}).catch(o=>{u(o)})});function h(e=!0){if(!e){$("#adequado").hide(),$("#vulneravel").hide();return}$("input[name='adequacao']:checked").val()>=vulnerabilidade?($("#adequado").hide(),$("#vulneravel").show()):($("#adequado").show(),$("#vulneravel").hide())}$("input[name='adequacao']").on("click",function(){h()});$("input[name='probabilidade']").on("click",function(){m()});$("input[name='impacto']").on("click",function(){m()});function m(e=!0){if(!e){$("#risco_altissimo").hide();return}let r=$("input[name='probabilidade']:checked").val(),o=$("input[name='impacto']:checked").val();r*o>=risco_altissimo?$("#risco_altissimo").show():$("#risco_altissimo").hide()}$("input[name='esforco']").on("click",function(){f()});$("input[name='valor']").on("click",function(){f()});function f(e=!0){if(!e){$("#curto_prazo").hide(),$("#medio_prazo").hide(),$("#longo_prazo").hide();return}let r=$("input[name='esforco']:checked").val(),o=$("input[name='valor']:checked").val(),a=r*o;a>=curto_prazo_minimo&&a<=curto_prazo_maximo&&($("#curto_prazo").show(),$("#medio_prazo").hide(),$("#longo_prazo").hide()),a>=medio_prazo_minimo&&a<=medio_prazo_maximo&&($("#curto_prazo").hide(),$("#medio_prazo").show(),$("#longo_prazo").hide()),a>=longo_prazo_minimo&&a<=longo_prazo_maximo&&($("#curto_prazo").hide(),$("#medio_prazo").hide(),$("#longo_prazo").show())}let _,k=indexedDB.open("FormulariosDB",1);k.onupgradeneeded=function(e){_=e.target.result,_.objectStoreNames.contains("respostas")||_.createObjectStore("respostas",{keyPath:"id",autoIncrement:!0})};k.onsuccess=function(e){_=e.target.result};k.onerror=function(e){console.error("Erro ao abrir o IndexedDB",e)};function y(e){return new Promise((r,o)=>{if(!(e instanceof Blob))return r(null);const a=new FileReader;a.onload=()=>r(a.result),a.onerror=o,a.readAsDataURL(e)})}$("#btn_salvar_respostas").click(async function(){g("btn_salvar_respostas",!1);let e=$(this).attr("pergunta"),r=$("input[name='adequacao']:checked").val()||1,o=$("input[name='probabilidade']:checked").val()||1,a=$("input[name='impacto']:checked").val()||1,n=$("input[name='esforco']:checked").val()||1,d=$("input[name='valor']:checked").val()||1,c=$("#resposta").val(),t=$("#formulario_id").val(),s=document.getElementById("foto"),p=s.files&&s.files[0],z=await y(p);const x={timestamp:new Date().toISOString(),formulario_id:t,pergunta_id:e,adequacao:r,probabilidade:o,impacto:a,esforco:n,valor:d,resposta:c,fotoBase64:z};if(v===!1){try{let l=_.transaction(["respostas"],"readwrite");l.objectStore("respostas").add(x),l.oncomplete=()=>q("Resposta salva localmente!"),l.onerror=B=>{u("Erro ao salvar localmente"),console.error("Erro IndexedDB:",B)}}catch(l){u("Erro ao salvar localmente"),console.error("Erro inesperado:",l)}finally{g("btn_salvar_respostas",!0)}return}const i=new FormData;i.append("formulario_id",t),i.append("pergunta_id",e),i.append("adequacao",r),i.append("probabilidade",o),i.append("impacto",a),i.append("esforco",n),i.append("valor",d),i.append("resposta",c),p&&i.append("foto",p),b.post("/formularios/responder_pergunta",i).then(l=>{q(l.data.mensagem),I("modal_dados_formulario"),location.reload()}).catch(l=>{u(l),console.error(l)}).finally(()=>{g("btn_salvar_respostas",!0)})});var v=!0;function D(){b.get(app_url+"/online").then(e=>{v=!0,$("#online").removeClass("bg-red-100"),$("#online").addClass("bg-green-100"),$("#online").html("ONLINE"),E()}).catch(e=>{v=!1,$("#online").removeClass("bg-green-100"),$("#online").addClass("bg-red-100"),$("#online").html("OFFLINE")})}setInterval(function(){D()},1e3);async function E(){if(!navigator.onLine)return;const e=indexedDB.open("FormulariosDB",1);e.onsuccess=function(r){const o=r.target.result,d=o.transaction(["respostas"],"readonly").objectStore("respostas").getAll();d.onsuccess=async function(){const c=d.result;for(let t of c){const s=new FormData;if(s.append("formulario_id",t.formulario_id),s.append("pergunta_id",t.pergunta_id),s.append("adequacao",t.adequacao),s.append("probabilidade",t.probabilidade),s.append("impacto",t.impacto),s.append("esforco",t.esforco),s.append("valor",t.valor),s.append("resposta",t.resposta),t.fotoBase64){const p=S(t.fotoBase64);s.append("foto",p)}try{const p=await b.post("/formularios/responder_pergunta",s);if(console.log("Sincronizado:",p.data),$("#online").html("ONLINE, Sincronizando..."),"id"in t){const i=o.transaction(["respostas"],"readwrite").objectStore("respostas").delete(t.id);i.onsuccess=()=>{console.log("Item excluído do IndexedDB:",t.id)},i.onerror=()=>{console.error("Erro ao excluir item do IndexedDB:",t.id),u("Erro ao excluir resposta sincronizada localmente.")}}else console.warn("Resposta sem ID. Não foi possível excluir:",t)}catch(p){console.error("Erro ao sincronizar resposta:",p),u("Erro ao enviar resposta offline para o servidor.")}}}},e.onerror=function(r){console.error("Erro ao abrir IndexedDB:",r),u("Não foi possível acessar os dados offline.")}}function S(e){const r=e.split(","),o=atob(r[1]),a=r[0].split(":")[1].split(";")[0],n=new ArrayBuffer(o.length),d=new Uint8Array(n);for(let c=0;c<o.length;c++)d[c]=o.charCodeAt(c);return new Blob([n],{type:a})}
